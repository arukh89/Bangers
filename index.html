<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Bangers | Farcaster Mini-App</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root{--bg:#0d0d0d;--card:#1a1a1a;--pink:#ff0055;--radius:14px;--fire:#ff6a00;}
    *{box-sizing:border-box;margin:0;padding:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial;}
    body{background:var(--bg);color:#fff;padding:16px;}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;}
    header h1{font-size:22px;font-weight:800;letter-spacing:.5px;}
    header button{background:var(--pink);border:none;color:#fff;padding:8px 16px;border-radius:var(--radius);font-weight:600;}
    .marquee{width:100%;overflow:hidden;background:#111;border:1px solid #333;border-radius:var(--radius);padding:10px 0;margin-bottom:20px;white-space:nowrap;box-sizing:border-box;}
    .marquee span{display:inline-block;padding-left:100%;animation:marquee 12s linear infinite;font-weight:700;color:#fff;letter-spacing:.5px;}
    @keyframes marquee{0%{transform:translateX(0%)}100%{transform:translateX(-100%)}}
    .section{background:var(--card);border-radius:var(--radius);padding:16px;margin-bottom:20px;}
    .section-title{font-size:18px;margin-bottom:12px;font-weight:700;display:flex;align-items:center;gap:8px;}
    .leader-item{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid #222;}
    .leader-item:last-child{border:none;}
    .rank{font-weight:800;color:var(--pink);}
    .name{font-weight:600;}
    .score{font-weight:700;color:#fff;}
    .member{border-bottom:1px solid #222;padding:14px 0;}
    .member:last-child{border:none;}
    .member-header{display:flex;align-items:center;gap:10px;margin-bottom:8px;}
    .member-pfp{width:36px;height:36px;border-radius:50%;object-fit:cover;background:var(--pink);}
    .fid{font-size:12px;color:#aaa;}
    .streak{font-size:13px;color:var(--fire);font-weight:700;}
    .actions{display:flex;gap:12px;margin-top:8px;}
    .btn{flex:1;background:#222;border:1px solid #333;color:#fff;padding:10px;border-radius:var(--radius);font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px;}
    .btn:hover{background:#333;}
    .btn.pink{background:var(--pink);border-color:var(--pink);}
    .btn.fire{background:var(--fire);border-color:var(--fire);}
    .loading{color:var(--pink);}
  </style>
</head>
<body>

<header>
  <h1>üéØ Bangers</h1>
  <button onclick="connect()">Connect</button>
</header>

<div class="marquee">
  <span>üî• Freedom is our right, unity is our power üî•</span>
</div>

<div class="section">
  <div class="section-title">üî• Bangers Leaderboard ‚Äì Top 5</div>
  <div id="board"></div>
</div>

<div class="section">
  <div class="section-title">üí¨ Channel members ‚Äì betonbangers</div>
  <div id="members" class="loading">loading‚Ä¶</div>
</div>

<script type="module">
  /* ---------- 0.  CONSTANTS ---------- */
  const CHANNEL_NAME = 'betonbangers';
  const API_BASE     = window.location.origin.replace('bangers-web','bangers-api');
  const MEMBERS_EP   = `${API_BASE}/members`;
  const LIKES_EP     = `${API_BASE}/likes`;
  const STREAK_EP    = `${API_BASE}/streak`;     // NEW
  let MY_FID         = 9999;                     // demo fid

  /* ---------- 1.  STREAK (NEW) ---------- */
  async function fetchStreak(fid = MY_FID) {
    const r = await fetch(`${STREAK_EP}/${fid}`);
    if (!r.ok) return { count: 0, lastDate: null };
    return r.json();
  }
  async function incrementStreak(fid = MY_FID) {
    await fetch(STREAK_EP, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ fid })
    });
  }

  /* ---------- 2.  LIKE COUNT ---------- */
  async function fetchLikeCount(castId = 'default') {
    const r = await fetch(`${LIKES_EP}/${castId}`);
    const { count } = await r.json();
    return count;
  }
  async function toggleLike(castId = 'default') {
    const r = await fetch(LIKES_EP, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ fid: MY_FID, castId })
    });
    return r.json();
  }

  /* ---------- 3.  MEMBERS (cached) ---------- */
  const DB_NAME = 'bangers_db';
  const STORE   = 'followers';
  async function openDB(){
    return new Promise((res, rej) => {
      const req = indexedDB.open(DB_NAME, 1);
      req.onerror = () => rej(req.error);
      req.onsuccess = () => res(req.result);
      req.onupgradeneeded = () => req.result.createObjectStore(STORE, {keyPath: 'fid'});
    });
  }
  async function saveFollowers(list){
    const db = await openDB();
    const tx = db.transaction(STORE, 'readwrite');
    list.forEach(u => tx.store.put(u));
    return tx.complete;
  }
  async function getFollowers(){
    const db = await openDB();
    return db.transaction(STORE).store.getAll();
  }
  async function loadChannelMembers(){
    const cached = await getFollowers();
    if (cached.length) renderMembers(cached);
    try {
      const r = await fetch(MEMBERS_EP);
      if (!r.ok) throw new Error(r.status);
      const data = await r.json();
      const users = data.map(u => ({
        fid: u.fid,
        username: u.username,
        displayName: u.displayName,
        pfp: u.pfp || `https://i.pravatar.cc/150?u=${u.fid}`
      }));
      await saveFollowers(users);
      renderMembers(users);
    } catch (e) {
      console.warn('live fetch failed', e);
      if (!cached.length) document.getElementById('members').textContent = 'offline ‚Äì no data';
    }
  }

  /* ---------- 4.  RENDER MEMBERS + STREAK ---------- */
  async function renderMembers(list){
    const box = document.getElementById('members');
    box.classList.remove('loading');
    for (const u of list) {
      const [count, streak] = await Promise.all([
        fetchLikeCount(u.fid),
        fetchStreak(u.fid)
      ]);
      const multiplier = 1 + (streak.count * 0.05); // +5 % per streak day
      const html = `
        <div class="member">
          <div class="member-header">
            <img class="member-pfp" src="${u.pfp}" alt="">
            <div>
              <div class="name">${u.displayName}</div>
              <div class="fid">fid:${u.fid}  @${u.username}</div>
              <div class="streak">üî• Streak ${streak.count}d  (√ó${multiplier.toFixed(2)})</div>
            </div>
          </div>
          <div class="actions">
            <button class="btn" onclick="likeBtn('${u.fid}')">üëç Like</button>
            <button id="like-${u.fid}" class="btn" onclick="toggleLikeBtn('${u.fid}')">
              ‚ù§Ô∏è Liked by <span>${count}</span>
            </button>
            <button class="btn fire" onclick="streakBtn('${u.fid}')">üî• Streak</button>
            <button class="btn" onclick="shareBtn('${u.username}')">üì§ Share</button>
          </div>
        </div>`;
      box.insertAdjacentHTML('beforeend', html);
    }
  }

  /* ---------- 5.  BUTTON HANDLERS ---------- */
  window.likeBtn = (castId) => alert('Liked! +10 Bangers');
  window.shareBtn = (user) => alert(`Share cast link for @${user}`);
  window.streakBtn = (castId) => alert('Keep the üî• alive ‚Äì like before 00:00 UTC!');
  window.toggleLikeBtn = async (castId) => {
    const btn   = document.getElementById(`like-${castId}`);
    const span  = btn.querySelector('span');
    const {liked, count} = await toggleLike(castId);
    span.textContent = count;
    btn.classList.toggle('pink', liked);
    if (liked) await incrementStreak(MY_FID); // üî• +1 streak
  };

  /* ---------- 6.  LEADERBOARD (static) ---------- */
  const leaders = [
    {rank:1,name:'ChainChirp',score:12000},
    {rank:2,name:'OxRobo',score:9500},
    {rank:3,name:'NeuralNode',score:8800},
    {rank:4,name:'DeepCast',score:6100},
    {rank:5,name:'GPTipS',score:4300}
  ];
  document.getElementById('board').innerHTML = leaders.map(l=>`
    <div class="leader-item">
      <div><span class="rank">#${l.rank}</span> <span class="name">${l.name}</span></div>
      <div class="score">${l.score.toLocaleString()} Bangers</div>
    </div>`).join('');

  /* ---------- 7.  BOOT ---------- */
  loadChannelMembers();
</script>

</body>
  </html>
  
